<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§§ é‡‘è›‡è¿æ˜¥ï¼šéˆä¸Šæ“²ç­Šåšé»ƒé‡‘ ğŸ§§</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>

    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body {
            background-color: #500000;
            background-image: linear-gradient(135deg, #800000 25%, #500000 100%);
            color: #FFD700;
            font-family: 'Microsoft JhengHei', sans-serif;
            text-align: center;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
            perspective: 1000px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            padding: 25px;
            border-radius: 20px;
            border: 2px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            position: relative;
        }
        h1 { margin-bottom: 5px; text-shadow: 2px 2px 4px #000; }

        /* --- å€’æ•¸è¨ˆæ™‚ --- */
        .countdown-bar {
            background: rgba(0, 0, 0, 0.6); border: 1px solid #FFD700; color: #fff;
            padding: 8px; border-radius: 50px; font-size: 14px; margin-bottom: 15px;
            display: inline-block; box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        .countdown-time { color: #00FF00; font-family: monospace; font-weight: bold; font-size: 16px; }

        /* --- å„€è¡¨æ¿ --- */
        .dashboard {
            background: linear-gradient(to bottom, #330000, #1a0000);
            border: 1px solid #FFA500; border-radius: 10px; padding: 15px; margin-bottom: 15px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .dashboard-row {
            display: flex; justify-content: space-between; align-items: center; font-size: 15px;
            border-bottom: 1px dashed #555; padding-bottom: 8px;
        }
        .highlight-val { color: #00FF00; font-weight: bold; font-family: monospace; font-size: 16px; }
        .gold-subtext { font-size: 12px; color: #ccc; margin-left: 5px; }

        .my-stats {
            display: flex; justify-content: space-around; background: #400000; padding: 10px;
            border-radius: 10px; margin-bottom: 20px; font-size: 14px; border: 1px solid #800000;
        }

        /* --- æŒ‰éˆ•å€ --- */
        .action-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;}
        .small-btn {
            background: rgba(255, 215, 0, 0.1); border: 1px solid #FFD700; color: #FFD700;
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.2s;
        }
        .small-btn:hover { background: rgba(255, 215, 0, 0.3); scale: 1.05; }
        .ref-btn {
            background: linear-gradient(90deg, #FF8C00, #FFD700);
            color: #500000; font-weight: bold; border: none;
            box-shadow: 0 0 10px #FF8C00;
        }
        .ref-btn:hover { box-shadow: 0 0 15px #FFD700; scale: 1.05; }
        .btn {
            background: linear-gradient(180deg, #FFD700, #FFA500); border: 1px solid #fff;
            padding: 15px 40px; font-size: 20px; font-weight: bold; color: #800000;
            cursor: pointer; border-radius: 50px; width: 80%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: all 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background: #555; color: #888; cursor: not-allowed; border-color: #555; }

        /* --- éŠæˆ²å€ --- */
        .game-stage {
            background: rgba(0,0,0,0.3); border-radius: 15px; padding: 20px 0;
            margin: 20px 0; border: 1px solid #800000; position: relative;
            overflow: hidden;
        }
        
        /* ç­Šæ¯å‹•ç•«å®¹å™¨ */
        .jiaobei-wrapper {
            height: 160px;
            display: flex; justify-content: center; align-items: center;
            gap: 60px;
            perspective: 1200px;
            position: relative; margin-bottom: 20px;
        }

        /* ç­Šæ¯æœ¬é«”é€šç”¨è¨­å®š */
        .jiaobei {
            width: 200px; height: 100px;
            background: transparent; border-radius: 0; box-shadow: none;
            position: relative; transform-style: preserve-3d;
            transition: transform 0.5s ease-out;
        }
        
        /* --- è²¼åœ–è¨­å®š --- */
        /* é€šç”¨ï¼šå¹³é¢ (Yang) */
        .jiaobei::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://i.ibb.co/twv7fJR8/Yang.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            /* é è¨­è®Šå½¢ï¼šç¿»è½‰åˆ°èƒŒé¢ */
            transform: rotateX(180deg) translateZ(1px); backface-visibility: hidden;
        }
        
        /* é€šç”¨ï¼šå‡¸é¢ (Yin) */
        .jiaobei::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://i.ibb.co/twFczdTG/Yin.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            /* é è¨­è®Šå½¢ï¼šåœ¨æ­£é¢ */
            transform: translateZ(-1px); backface-visibility: hidden;
        }

        /* âœ…âœ…âœ… é—œéµä¿®æ”¹ï¼šå¼·åˆ¶é¡åƒç¿»è½‰å³é‚Šçš„ç­Šæ¯ (Block B) çš„è²¼åœ– âœ…âœ…âœ… */
        #blockB::before {
            /* åŠ ä¸Š scaleX(-1) é€²è¡Œæ°´å¹³ç¿»è½‰ï¼Œä¸¦ä¿æŒåŸæœ¬çš„ rotateX å’Œ translateZ */
            transform: scaleX(-1) rotateX(180deg) translateZ(1px);
        }
        #blockB::after {
            /* åŠ ä¸Š scaleX(-1) é€²è¡Œæ°´å¹³ç¿»è½‰ï¼Œä¸¦ä¿æŒåŸæœ¬çš„ translateZ */
            transform: scaleX(-1) translateZ(-1px);
        }
        /* âœ…âœ…âœ… ä¿®æ”¹çµæŸ âœ…âœ…âœ… */


        /* é™°å½± */
        .shadow-layer {
            position: absolute; bottom: -10px; width: 160px; height: 30px;
            background: rgba(0,0,0,0.5); border-radius: 50%; filter: blur(10px); z-index: -1;
        }

        .integrated-result {
            min-height: 40px; display: flex; flex-direction: column; justify-content: center;
            align-items: center; font-size: 20px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* å‹•ç•« Keyframes */
        @keyframes tumble-up {
            0% { transform: translateY(0) rotateX(0) rotateY(0) rotateZ(0) scale(1); }
            20% { transform: translateY(-100px) rotateX(360deg) rotateY(180deg) rotateZ(45deg) scale(1.1); }
            60% { transform: translateY(-80px) rotateX(1080deg) rotateY(540deg) rotateZ(180deg) scale(1.05); }
            100% { transform: translateY(0) rotateX(1800deg) rotateY(900deg) rotateZ(360deg) scale(1); }
        }
        @keyframes shadow-scale { 0%, 100% { opacity: 0.8; transform: scale(1); } 20%, 40% { opacity: 0.3; transform: scale(0.6); } }
        .tossing { animation: tumble-up 0.8s infinite linear; }
        .tossing-shadow { animation: shadow-scale 0.8s infinite linear; }
        
        /* çµæœç‹€æ…‹ */
        .state-yin { transform: rotateX(0deg); } 
        .state-yang { transform: rotateX(180deg); } 
        .state-li { transform: rotateX(-90deg) rotateY(0deg) rotateZ(90deg); filter: drop-shadow(0 0 15px #FF00FF); }

        .input-group { margin: 10px 0; }
        input {
            padding: 12px; font-size: 20px; border-radius: 8px; border: 2px solid #FFD700;
            background: #200000; color: #fff; text-align: center; width: 180px; font-weight: bold;
        }
        .max-bet-hint { font-size: 13px; color: #FFA500; margin-top: 5px; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: #300000; border: 2px solid #FFD700; margin: 5% auto; padding: 25px; width: 85%; max-width: 450px; border-radius: 15px; text-align: left; box-shadow: 0 0 30px #FFD700; max-height: 80vh; overflow-y: auto;}
        .close-btn { float: right; font-size: 32px; cursor: pointer; color: #aaa; }
        .leader-addr { color: #00FFFF; font-family: monospace; font-size: 20px; font-weight: bold; }
        .leader-section { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 15px; border: 1px solid #FFD700; text-align: center; margin-bottom: 20px; }
        .history-list { margin-top: 20px; font-size: 14px; border-top: 1px solid #555; padding-top: 10px; }
        .history-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #444; color: #ddd; }
        .history-item:last-child { border-bottom: none; }
        .h-addr { color: #00FFFF; font-family: monospace; }
        .h-val { color: #FFD700; font-weight: bold; }
        .hash-box { margin-top: 10px; font-size: 10px; color: #555; }
        .ref-info { font-size: 12px; color: #00FF00; margin-bottom: 5px; display: none; }

        @keyframes flash { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        .critical { color: #FF00FF; text-shadow: 0 0 15px #FF00FF; animation: flash 0.4s infinite; font-size: 24px; }
        .sheng-jiao { color: #FFD700; text-shadow: 0 0 10px #FFD700; font-size: 22px; }
        .xiao-jiao { color: #FFA500; font-size: 20px; }
        .yin-jiao { color: #aaa; font-size: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¯ è™çˆºè³œç¦æ“²ç­Šå° ğŸ¯</h1>

    <div class="countdown-bar">
        ğŸ† æœ¬é€±çµç®—å€’æ•¸: <span id="countdownDisplay" class="countdown-time">è¨ˆç®—ä¸­...</span>
    </div>
    
    <div class="dashboard">
        <div class="dashboard-row">
            <span>ğŸ’ é€£å‹ç´¯ç©çæ± :</span>
            <div style="text-align: right;">
                <span class="highlight-val" id="streakPool">0.0000</span> BNB<br>
                <span class="gold-subtext" id="streakPoolGold">(â‰ˆ 0g é»ƒé‡‘)</span>
            </div>
        </div>
    </div>

    <div class="my-stats">
        <div>ğŸ’° é¤˜é¡: <span id="userBalance" style="color:#fff">---</span></div>
        <div>ğŸ² é€£å‹: <span id="userStreak" style="color:#fff">0</span></div>
    </div>

    <div class="action-bar">
        <button class="small-btn ref-btn" onclick="copyReferralLink()">ğŸ“‹ è¤‡è£½æ¨å»£é€£çµ (è³º5%)</button>
        <button class="small-btn" onclick="openLeaderboard()">ğŸ† æ¦œå–® & ç´€éŒ„</button>
        <button class="small-btn" onclick="openRules()">ğŸ“œ è¦å‰‡</button>
    </div>

    <button id="connectBtn" class="btn" onclick="connectWallet()">ğŸ¦Š é€£çµéŒ¢åŒ… (Connect)</button>
    
    <div id="gameArea" style="display:none;">
        
        <div id="refDisplay" class="ref-info">ğŸ”— å·²ç¶å®šæ¨è–¦äºº: 0x...</div>

        <div class="game-stage">
            <div class="jiaobei-wrapper">
                <div style="position: relative;">
                    <div id="blockA" class="jiaobei state-yin"></div>
                    <div id="shadowA" class="shadow-layer"></div>
                </div>
                <div style="position: relative;">
                    <div id="blockB" class="jiaobei state-yang"></div>
                    <div id="shadowB" class="shadow-layer"></div>
                </div>
            </div>
            
            <div class="integrated-result" id="resultDisplay">
                <span style="font-size: 16px; color:#ccc; font-weight:normal;">æº–å‚™æ“²ç­Š...</span>
            </div>
            <div class="hash-box" id="hashDisplay"></div>
        </div>

        <div class="input-group">
            <label>ä¸‹æ³¨é‡‘é¡ (BNB)</label><br>
            <input type="number" id="betAmount" value="0.001" step="0.001" min="0.001">
            <div class="max-bet-hint" id="maxBetDisplay">æ­£åœ¨è¨ˆç®—æœ€å¤§é™é¡...</div>
        </div>

        <button id="playBtn" class="btn" onclick="playGame()">ğŸ™ èª å¿ƒæ“²ç­Š (Play)</button>
    </div>
</div>

<div id="leaderModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('leaderModal')">&times;</span>
        <h2 style="text-align:center; color:#FFD700; margin-top:0;">ğŸ† é€£å‹æ®¿å ‚ ğŸ†</h2>
        <div class="leader-section">
            <div style="font-size:40px; margin-bottom:10px;">ğŸ‘‘</div>
            <div style="color:#aaa; font-size:14px; margin-bottom:5px;">ç•¶å‰å…¨ç¶²é€£å‹éœ¸ä¸»</div>
            <div class="leader-addr" id="modalWinnerAddr">---</div>
            <div style="margin-top: 15px;">
                <div style="color:#aaa; font-size:14px;">æœ€é«˜é€£å‹ç´€éŒ„</div>
                <span style="font-size:36px; color:#FFD700; font-weight:bold;" id="modalHighestStreak">0</span>
                <span style="color:#FFD700">æ¬¡</span>
            </div>
        </div>
        <div style="text-align:center; color:#ccc; margin-bottom: 20px;">
            <div style="font-size:16px; color:#fff;">ğŸ‘¤ æˆ‘çš„ç´€éŒ„: <span id="modalMyStreak" style="color:#00FF00; font-weight:bold;">0</span> æ¬¡</div>
        </div>
        <div style="border-top: 1px dashed #555; padding-top: 10px;">
            <h3 style="color:#FFD700; text-align:center; margin:10px 0;">ğŸ“œ æ­·å±†å† è»ç´€éŒ„</h3>
            <div id="historyListContainer" class="history-list">
                <div style="text-align:center; color:#888;">æ­£åœ¨è¼‰å…¥æ­·å²æ•¸æ“š...</div>
            </div>
        </div>
    </div>
</div>

<div id="rulesModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('rulesModal')">&times;</span>
        <h2 style="text-align:center; color:#FFD700; margin-top:0;">ğŸ“œ éŠæˆ²è¦å‰‡</h2>
        <div style="margin-bottom:20px;">
            <div style="color:#FFD700; font-weight:bold; margin-bottom:8px;">ğŸ’ ç²å‹èˆ‡è³ ç‡</div>
            <div style="margin-left:10px; color:#eee; line-height:1.8;">
                âš¡ <strong>ç«‹ç­Š (æš´æ“Š)</strong>ï¼š<span style="color:#FF00FF;">8 å€</span><br>
                ğŸ™ <strong>è–ç­Š (ç²å‹)</strong>ï¼š<span style="color:#FFD700;">2 å€</span><br>
                ğŸ˜Š <strong>ç¬‘ç­Š (å¹³å±€)</strong>ï¼šé€€é‚„ä¸€åŠ<br>
                ğŸŒ‘ <strong>é™°ç­Š (æœªä¸­)</strong>ï¼šä¸‹æ¬¡å¥½é‹
            </div>
        </div>
        <div>
            <div style="color:#FFD700; font-weight:bold; margin-bottom:8px;">ğŸ’° è³‡é‡‘åˆ†é…</div>
            <div style="margin-left:10px; color:#eee; line-height:1.8;">
                75% æ“²ç­Šæ±  | 10% é€£å‹æ± <br>
                10% å¹´ç¸æ±  | <span style="color:#00FF00">5% æ¨è–¦çå‹µ</span>
            </div>
        </div>
    </div>
</div>

<script>
    const CONTRACT_ADDRESS = "0x84b31049Eb8CB25cF86d360534e383d8b0e10924"; 
    
    const BNB_PRICE_USD = 620; 
    const GOLD_PRICE_USD_PER_GRAM = 85; 

    const ABI = [
        "function play(address referrer) external payable",
        "function userStreaks(address) view returns (uint256, uint256, uint256, uint256)",
        "function streakPoolBalance() view returns (uint256)",
        "function currentWeeklyWinner() view returns (address)",
        "function highestStreak() view returns (uint256)",
        "function nextSettleTime() view returns (uint256)", 
        "event GameResult(address indexed player, string resultType, uint256 payout, uint256 rawRandom, uint256 betAmount, bytes32 gameHash)",
        "event WeeklyWinnerPaid(address indexed winner, uint256 amount)"
    ];

    let provider, signer, contract;
    let currentMaxBet = 0; 
    let cachedWinner = "---";
    let cachedHighest = 0;
    let myCurrentStreak = 0;
    let countdownInterval;
    let globalReferrer = "0x0000000000000000000000000000000000000000";

    async function connectWallet() {
        if (typeof ethers === 'undefined') { alert("Ethers.js è¼‰å…¥å¤±æ•—"); return; }
        if (!window.ethereum) { alert("è«‹å®‰è£ MetaMask!"); return; }
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []); 
            signer = provider.getSigner();
            const address = await signer.getAddress();
            
            document.getElementById("connectBtn").innerText = "âœ… å·²é€£çµ";
            document.getElementById("connectBtn").disabled = true; 
            document.getElementById("gameArea").style.display = "block";

            checkReferralParam(address);

            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            await updateAllStats(address);
            startCountdown(); 
            
            contract.on("GameResult", () => { updateAllStats(address); });
            contract.on("WeeklyWinnerPaid", (winner, amount) => {
                const amt = ethers.utils.formatEther(amount);
                alert(`âœ¨ æ­å–œï¼æœ¬é€±çµç®—è‡ªå‹•è§¸ç™¼ï¼\néœ¸ä¸» ${winner.substring(0,6)}... å·²ç²å¾— ${amt} BNB\næ–°è³½å­£å·²ç¶“é–‹å§‹ï¼`);
                updateAllStats(address);
                startCountdown(); 
            });

        } catch (error) { console.error(error); alert("é€£çµå¤±æ•—: " + error.message); }
    }

    function checkReferralParam(myAddr) {
        const urlParams = new URLSearchParams(window.location.search);
        const refParam = urlParams.get('ref');
        if (refParam && ethers.utils.isAddress(refParam) && refParam.toLowerCase() !== myAddr.toLowerCase()) {
            globalReferrer = refParam;
            const displayRef = refParam.substring(0, 6) + "..." + refParam.substring(38);
            document.getElementById("refDisplay").innerText = `ğŸ”— å·²ç¶å®šæ¨è–¦äºº: ${displayRef}`;
            document.getElementById("refDisplay").style.display = "block";
        }
    }

    async function copyReferralLink() {
        if (!signer) { alert("è«‹å…ˆé€£çµéŒ¢åŒ…ï¼"); return; }
        const myAddr = await signer.getAddress();
        const baseUrl = window.location.origin + window.location.pathname;
        const refLink = `${baseUrl}?ref=${myAddr}`;
        navigator.clipboard.writeText(refLink).then(() => {
            alert("âœ… é€£çµå·²è¤‡è£½ï¼\nç™¼é€çµ¦æœ‹å‹ï¼Œä»–å€‘ä¸‹æ³¨é‡‘é¡çš„ 5% å°‡è‡ªå‹•ç™¼é€çµ¦ä½ ï¼");
        }, () => { alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¶²å€ä¸¦åŠ ä¸Š ?ref=" + myAddr); });
    }

    async function updateAllStats(userAddress) {
        try {
            const balance = await provider.getBalance(userAddress);
            document.getElementById("userBalance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
            const uStreak = await contract.userStreaks(userAddress);
            myCurrentStreak = uStreak[0].toString();
            document.getElementById("userStreak").innerText = myCurrentStreak;
            
            const sPool = await contract.streakPoolBalance();
            const sPoolBNB = parseFloat(ethers.utils.formatEther(sPool));
            const sPoolGold = (sPoolBNB * BNB_PRICE_USD / GOLD_PRICE_USD_PER_GRAM).toFixed(4);
            document.getElementById("streakPool").innerText = sPoolBNB.toFixed(4);
            document.getElementById("streakPoolGold").innerText = `(â‰ˆ ${sPoolGold}g é»ƒé‡‘)`;

            cachedHighest = await contract.highestStreak();
            const winner = await contract.currentWeeklyWinner();
            cachedWinner = (winner === "0x0000000000000000000000000000000000000000") ? "å°šç„¡ (è™›ä½ä»¥å¾…)" : winner;
            
            const contractBalance = await provider.getBalance(CONTRACT_ADDRESS);
            const availablePool = contractBalance.sub(sPool);
            const maxBetBNB = availablePool.div(10);
            currentMaxBet = parseFloat(ethers.utils.formatEther(maxBetBNB));
            const hintEl = document.getElementById("maxBetDisplay");
            if (currentMaxBet <= 0.001) {
                hintEl.innerHTML = `âš ï¸ æ± åº•ä¹¾æ¯ï¼Œåƒ…é™ <span style='color:#fff'>0.001</span> BNB`;
                hintEl.style.color = "#FF4444";
            } else {
                hintEl.innerHTML = `âš ï¸ å–®ç­†ä¸Šé™: <span style='color:#00FF00'>${currentMaxBet.toFixed(4)}</span> BNB`;
                hintEl.style.color = "#FFA500";
            }
        } catch (e) { console.error(e); }
    }

    async function startCountdown() {
        if (!contract) return;
        try {
            const nextTimeBig = await contract.nextSettleTime();
            const nextTime = nextTimeBig.toNumber();
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const now = Math.floor(Date.now() / 1000);
                const diff = nextTime - now;
                if (diff <= 0) { document.getElementById("countdownDisplay").innerText = "ç­‰å¾…ç©å®¶è§¸ç™¼çµç®—..."; return; }
                const d = Math.floor(diff / (3600 * 24));
                const h = Math.floor((diff % (3600 * 24)) / 3600);
                const m = Math.floor((diff % 3600) / 60);
                const s = diff % 60;
                document.getElementById("countdownDisplay").innerText = `${d}å¤© ${h}æ™‚ ${m}åˆ† ${s}ç§’`;
            }, 1000);
        } catch (e) { console.error("Countdown Error:", e); }
    }

    async function fetchHistory() {
        if (!contract) return;
        const container = document.getElementById("historyListContainer");
        container.innerHTML = "<div style='text-align:center; color:#888;'>æ­£åœ¨æŸ¥è©¢å€å¡Šéˆç´€éŒ„...</div>";
        try {
            const filter = contract.filters.WeeklyWinnerPaid();
            const events = await contract.queryFilter(filter);
            if (events.length === 0) { container.innerHTML = "<div style='text-align:center; color:#888;'>å°šç„¡æ­·å²å† è»ç´€éŒ„</div>"; return; }
            let html = "";
            for (const evt of events.reverse()) {
                const winner = evt.args.winner;
                const amount = ethers.utils.formatEther(evt.args.amount);
                const block = await evt.getBlock();
                const date = new Date(block.timestamp * 1000);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes()}`;
                html += `<div class="history-item"><span style="color:#aaa; width:90px;">${dateStr}</span><span class="h-addr">${winner.substring(0,6)}...${winner.substring(38)}</span><span class="h-val">${parseFloat(amount).toFixed(4)} BNB</span></div>`;
            }
            container.innerHTML = html;
        } catch (e) { console.error(e); container.innerHTML = "<div style='text-align:center; color:red;'>è®€å–å¤±æ•—</div>"; }
    }

    function setBlocksState(state) {
        const bA = document.getElementById("blockA"); const bB = document.getElementById("blockB");
        const sA = document.getElementById("shadowA"); const sB = document.getElementById("shadowB");
        const classes = ["state-yin", "state-yang", "state-li", "tossing"];
        bA.classList.remove(...classes); bB.classList.remove(...classes);
        sA.classList.remove("tossing-shadow"); sB.classList.remove("tossing-shadow");
        if (state === "tossing") { bA.classList.add("tossing"); bB.classList.add("tossing"); sA.classList.add("tossing-shadow"); sB.classList.add("tossing-shadow"); }
        else if (state === "sheng") { bA.classList.add("state-yang"); bB.classList.add("state-yin"); }
        else if (state === "xiao") { bA.classList.add("state-yang"); bB.classList.add("state-yang"); }
        else if (state === "yin") { bA.classList.add("state-yin"); bB.classList.add("state-yin"); }
        else if (state === "li") { bA.classList.add("state-li"); bB.classList.add("state-li"); }
    }

    async function playGame() {
        if (!contract) return;
        const betInput = document.getElementById("betAmount").value;
        const betValue = parseFloat(betInput);
        if (betValue < 0.001) { alert("æœ€å°ä¸‹æ³¨é‡‘é¡ç‚º 0.001 BNB"); return; }
        if (betValue > currentMaxBet && currentMaxBet > 0.001) { alert(`é‡‘é¡éå¤§ï¼ä¸Šé™ ${currentMaxBet.toFixed(4)}`); return; }
        try {
            document.getElementById("resultDisplay").innerHTML = "<span style='color:#FFD700;'>ğŸ² æ“²ç­Šä¸­... (è«‹ç¢ºèªäº¤æ˜“)</span>";
            document.getElementById("playBtn").disabled = true;
            document.getElementById("playBtn").innerText = "â³ äº¤æ˜“ç¢ºèªä¸­...";
            setBlocksState("tossing");
            
            const tx = await contract.play(globalReferrer, { 
                value: ethers.utils.parseEther(betInput), gasLimit: 500000 
            });
            document.getElementById("resultDisplay").innerHTML = "ğŸš€ ç­‰å¾…çµæœ...";
            const receipt = await tx.wait();
            const event = receipt.events.find(e => e.event === 'GameResult');
            if (event) displayResult(event.args);
        } catch (error) {
            console.error(error); alert("äº¤æ˜“å¤±æ•—");
            document.getElementById("resultDisplay").innerHTML = "<span style='color:red'>âŒ äº¤æ˜“å¤±æ•—</span>";
            setBlocksState("sheng");
        } finally {
            document.getElementById("playBtn").disabled = false;
            document.getElementById("playBtn").innerText = "ğŸ™ èª å¿ƒæ“²ç­Š (Play)";
        }
    }

    function displayResult(args) {
        const { resultType, payout, gameHash } = args;
        document.getElementById("hashDisplay").innerText = "Hash: " + gameHash.substring(0, 15) + "..."; 
        const payoutBNB = ethers.utils.formatEther(payout);
        let resultHtml = "";
        if (resultType.includes("Li Jiao")) { setBlocksState("li"); resultHtml = `<div class='critical'>âš¡ ç«‹ç­Š (8X)</div><div style='color:#fff; font-size:16px;'>ç² ${payoutBNB} BNB</div>`; }
        else if (resultType.includes("Sheng Jiao")) { setBlocksState("sheng"); resultHtml = `<div class='sheng-jiao'>ğŸ™ è–ç­Š (2X)</div><div style='color:#fff; font-size:16px;'>ç² ${payoutBNB} BNB</div>`; }
        else if (resultType.includes("Xiao Jiao")) { setBlocksState("xiao"); resultHtml = `<div class='xiao-jiao'>ğŸ˜Š ç¬‘ç­Š (é€€åŠ)</div><div style='color:#ccc; font-size:14px;'>é€£å‹ä¸­æ–·</div>`; }
        else { setBlocksState("yin"); resultHtml = `<div class='yin-jiao'>ğŸŒ‘ é™°ç­Š (ç„¡)</div><div style='color:#ccc; font-size:14px;'>é€£å‹æ­¸é›¶</div>`; }
        document.getElementById("resultDisplay").innerHTML = resultHtml;
        signer.getAddress().then(addr => updateAllStats(addr));
    }

    function openLeaderboard() {
        const winnerText = cachedWinner === "å°šç„¡ (è™›ä½ä»¥å¾…)" ? cachedWinner : (cachedWinner.substring(0,8) + "..." + cachedWinner.substring(36));
        document.getElementById("modalWinnerAddr").innerText = winnerText;
        document.getElementById("modalHighestStreak").innerText = cachedHighest.toString();
        document.getElementById("modalMyStreak").innerText = myCurrentStreak.toString();
        document.getElementById("leaderModal").style.display = "block";
        fetchHistory();
    }
    function openRules() { document.getElementById("rulesModal").style.display = "block"; }
    function closeModal(id) { document.getElementById(id).style.display = "none"; }
    window.onclick = function(e) { if(e.target.className === "modal") e.target.style.display="none"; }
</script>

</body>
</html>
