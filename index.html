<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§§ é‡‘è›‡è¿æ˜¥ï¼šéˆä¸Šæ“²ç­Šåšé»ƒé‡‘ ğŸ§§</title>
    
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>

    <style>
        body {
            background-color: #500000;
            background-image: linear-gradient(135deg, #800000 25%, #500000 100%);
            color: #FFD700;
            font-family: 'Microsoft JhengHei', sans-serif;
            text-align: center;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            padding: 25px;
            border-radius: 20px;
            border: 2px solid #FFD700;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }
        h1 { margin-bottom: 5px; text-shadow: 2px 2px 4px #000; }
        
        /* å„€è¡¨æ¿ */
        .dashboard {
            background: linear-gradient(to bottom, #330000, #1a0000);
            border: 1px solid #FFA500;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .dashboard-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            border-bottom: 1px dashed #555;
            padding-bottom: 8px;
        }
        .dashboard-row:last-child { border-bottom: none; padding-bottom: 0; }
        .highlight-val { color: #00FF00; font-weight: bold; font-family: monospace; font-size: 16px; }
        .winner-addr { color: #00FFFF; font-family: monospace; }

        /* æŒ‰éˆ• */
        .btn {
            background: linear-gradient(180deg, #FFD700, #FFA500);
            border: 1px solid #fff;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            color: #800000;
            cursor: pointer;
            border-radius: 50px;
            margin: 15px 0;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            width: 80%;
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background: #555; color: #888; cursor: not-allowed; border-color: #555; }
        
        .input-group { margin: 20px 0 10px 0; }
        input {
            padding: 12px;
            font-size: 20px;
            border-radius: 8px;
            border: 2px solid #FFD700;
            background: #200000;
            color: #fff;
            text-align: center;
            width: 180px;
            font-weight: bold;
        }
        .max-bet-hint { font-size: 13px; color: #FFA500; margin-top: 5px; }
        
        .hash-box {
            background-color: #000;
            color: #00FF00;
            font-family: 'Courier New', monospace;
            padding: 12px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 12px;
            word-break: break-all;
            min-height: 20px;
            border: 1px solid #333;
        }

        .result-area {
            margin-top: 20px;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: bold;
        }
        .gold-text {
            color: #fff;
            font-size: 15px;
            margin-top: 8px;
            background: rgba(218, 165, 32, 0.4);
            padding: 5px 12px;
            border-radius: 20px;
        }
        
        .my-stats {
            display: flex;
            justify-content: space-around;
            background: #400000;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            border: 1px solid #800000;
        }

        /* ç‰¹æ•ˆ */
        @keyframes flash { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }
        .critical { color: #FF00FF; text-shadow: 0 0 15px #FF00FF; animation: flash 0.4s infinite; font-size: 26px; }
        .sheng-jiao { color: #FFD700; text-shadow: 0 0 10px #FFD700; }
        .xiao-jiao { color: #FFA500; }
        .yin-jiao { color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¯ è™çˆºè³œç¦æ“²ç­Šå° ğŸ¯</h1>
    <p>é€£çµéŒ¢åŒ… -> è¼¸å…¥é‡‘é¡ -> æ“²å‡ºè–ç­Šæ‹¿é»ƒé‡‘ï¼</p>
    
    <div class="dashboard">
        <div class="dashboard-row">
            <span>ğŸ† ç•¶é€±é€£å‹ç‹:</span>
            <span class="winner-addr" id="weeklyWinner">---</span>
        </div>
        <div class="dashboard-row">
            <span>ğŸ”¥ æœ€é«˜é€£å‹ç´€éŒ„:</span>
            <span class="highlight-val" id="highestStreak">0</span>
        </div>
        <div class="dashboard-row">
            <span>ğŸ’ é€£å‹ç´¯ç©çæ± :</span>
            <span><span class="highlight-val" id="streakPool">0.0000</span> BNB</span>
        </div>
    </div>

    <div class="my-stats">
        <div>ğŸ’° é¤˜é¡: <span id="userBalance" style="color:#fff">---</span></div>
        <div>ğŸ² é€£å‹: <span id="userStreak" style="color:#fff">0</span></div>
    </div>

    <button id="connectBtn" class="btn" onclick="connectWallet()">ğŸ¦Š é€£çµéŒ¢åŒ… (Connect)</button>
    
    <div id="gameArea" style="display:none;">
        <div class="input-group">
            <label>ä¸‹æ³¨é‡‘é¡ (BNB)</label><br>
            <input type="number" id="betAmount" value="0.001" step="0.001" min="0.001">
            <div class="max-bet-hint" id="maxBetDisplay">æ­£åœ¨è¨ˆç®—æœ€å¤§é™é¡...</div>
        </div>

        <button id="playBtn" class="btn" onclick="playGame()">ğŸ™ èª å¿ƒæ“²ç­Š (Play)</button>

        <div class="hash-box" id="hashDisplay">
            [ è«‹å…ˆæ“²ç­Šï¼Œç­‰å¾…å€å¡Šéˆç”Ÿæˆéš¨æ©Ÿç¢¼... ]
        </div>

        <div class="result-area" id="resultDisplay">
            æº–å‚™å¥½äº†å—ï¼Ÿ<br>è™çˆºçœ‹è‘—ä½ å‘¢...
        </div>
    </div>
</div>

<script>
    // âœ… åˆç´„åœ°å€
    const CONTRACT_ADDRESS = "0x7A427604Ff8Ce728A60cF5cB247B30C0cE29188B"; 

    // åŒ¯ç‡
    const BNB_PRICE_USD = 620; 
    const GOLD_PRICE_USD_PER_GRAM = 85; 

    // ABI
    const ABI = [
        "function play(address referrer) external payable",
        "function userStreaks(address) view returns (uint256, uint256, uint256, uint256)",
        "function streakPoolBalance() view returns (uint256)",
        "function currentWeeklyWinner() view returns (address)",
        "function highestStreak() view returns (uint256)",
        "event GameResult(address indexed player, string resultType, uint256 payout, uint256 rawRandom, uint256 betAmount, bytes32 gameHash)"
    ];

    let provider, signer, contract;
    let currentMaxBet = 0; 

    async function connectWallet() {
        if (typeof ethers === 'undefined') { alert("Ethers.js è¼‰å…¥å¤±æ•—"); return; }
        if (!window.ethereum) { alert("è«‹å®‰è£ MetaMask!"); return; }
        
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []); 
            signer = provider.getSigner();
            const address = await signer.getAddress();
            
            document.getElementById("connectBtn").innerText = "âœ… å·²é€£çµ: " + address.substring(0,6) + "...";
            document.getElementById("connectBtn").disabled = true; 
            document.getElementById("gameArea").style.display = "block";

            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            
            await updateAllStats(address);
            
            // ç›£è½å…¨å±€äº‹ä»¶ (åƒ…ç”¨æ–¼æ›´æ–°æ¦œå–®ï¼Œä¸è™•ç†å€‹äººçµæœ)
            contract.on("GameResult", () => { updateAllStats(address); });

        } catch (error) {
            console.error(error);
            alert("é€£çµå¤±æ•—: " + error.message);
        }
    }

    async function updateAllStats(userAddress) {
        try {
            const balance = await provider.getBalance(userAddress);
            document.getElementById("userBalance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
            
            const uStreak = await contract.userStreaks(userAddress);
            document.getElementById("userStreak").innerText = uStreak[0].toString();

            const sPool = await contract.streakPoolBalance();
            const hStreak = await contract.highestStreak();
            const winner = await contract.currentWeeklyWinner();

            document.getElementById("streakPool").innerText = parseFloat(ethers.utils.formatEther(sPool)).toFixed(4);
            document.getElementById("highestStreak").innerText = hStreak.toString();
            
            if (winner === "0x0000000000000000000000000000000000000000") {
                document.getElementById("weeklyWinner").innerText = "å°šç„¡ (è™›ä½ä»¥å¾…)";
            } else {
                document.getElementById("weeklyWinner").innerText = winner.substring(0,6) + "..." + winner.substring(38);
            }

            const contractBalance = await provider.getBalance(CONTRACT_ADDRESS);
            const availablePool = contractBalance.sub(sPool);
            const maxBetBNB = availablePool.div(10);
            
            currentMaxBet = parseFloat(ethers.utils.formatEther(maxBetBNB));
            
            const hintEl = document.getElementById("maxBetDisplay");
            if (currentMaxBet <= 0.001) {
                hintEl.innerHTML = `âš ï¸ æ± åº•ä¹¾æ¯ï¼Œåƒ…é™ä¸‹æ³¨ <span style='color:#fff'>0.001</span> BNB`;
                hintEl.style.color = "#FF4444";
            } else {
                hintEl.innerHTML = `âš ï¸ ç•¶å‰å–®ç­†ä¸Šé™: <span style='color:#00FF00'>${currentMaxBet.toFixed(4)}</span> BNB`;
                hintEl.style.color = "#FFA500";
            }

        } catch (e) { console.error("Update Stats Error:", e); }
    }

    // --- æ ¸å¿ƒä¿®æ”¹ï¼šæ”¹ç”¨ Receipt è§£æï¼Œä¸å†è¢«å‹•ç­‰å¾… ---
    async function playGame() {
        if (!contract) return;
        
        const betInput = document.getElementById("betAmount").value;
        const betValue = parseFloat(betInput);

        if (betValue < 0.001) { alert("æœ€å°ä¸‹æ³¨é‡‘é¡ç‚º 0.001 BNB"); return; }
        if (betValue > currentMaxBet && currentMaxBet > 0.001) {
             alert(`é‡‘é¡éå¤§ï¼ç•¶å‰æœ€å¤§é™åˆ¶ç‚º ${currentMaxBet.toFixed(4)} BNB`);
             return;
        }

        const referrer = "0x0000000000000000000000000000000000000000"; 

        try {
            document.getElementById("resultDisplay").innerHTML = "ğŸ² æ“²ç­Šä¸­...<br><span style='font-size:16px; color:#FFD700'>è«‹åœ¨éŒ¢åŒ…ç¢ºèªäº¤æ˜“...</span>";
            document.getElementById("hashDisplay").innerText = "ç­‰å¾…å€å¡Šéˆç¢ºèªä¸­...";
            document.getElementById("playBtn").disabled = true;
            document.getElementById("playBtn").innerText = "â³ äº¤æ˜“ç¢ºèªä¸­...";

            const tx = await contract.play(referrer, { 
                value: ethers.utils.parseEther(betInput) 
            });
            
            console.log("Tx Hash:", tx.hash);
            document.getElementById("resultDisplay").innerHTML = "ğŸš€ äº¤æ˜“å·²ç™¼é€ï¼<br><span style='font-size:16px; color:#ccc'>ç­‰å¾…å€å¡Šæ‰“åŒ… (ç´„3ç§’)...</span>";
            
            // âš ï¸ é—œéµä¿®æ­£ï¼šç­‰å¾…ä¸¦ç›´æ¥è§£ææ”¶æ“š
            const receipt = await tx.wait();
            
            // å¾æ”¶æ“šä¸­æ‰¾åˆ° GameResult äº‹ä»¶
            const event = receipt.events.find(e => e.event === 'GameResult');
            
            if (event) {
                // ç›´æ¥ä½¿ç”¨é€™è£¡çš„æ•¸æ“šæ›´æ–° UIï¼Œä¸ä¾è³´ Event Listener
                displayResult(event.args);
            } else {
                throw new Error("æœªæ‰¾åˆ°éŠæˆ²çµæœäº‹ä»¶");
            }

        } catch (error) {
            console.error(error);
            let msg = error.data?.message || error.message;
            if (msg.includes("insufficient funds")) msg = "é¤˜é¡ä¸è¶³ï¼";
            if (msg.includes("Bet too large")) msg = "ä¸‹æ³¨é‡‘é¡è¶…éæ± å­ 1/10 é™åˆ¶ï¼";
            
            alert("äº¤æ˜“å¤±æ•—: " + msg);
            document.getElementById("resultDisplay").innerText = "âŒ äº¤æ˜“æœªå®Œæˆ";
        } finally {
            // ç„¡è«–æˆåŠŸå¤±æ•—ï¼Œéƒ½é‡ç½®æŒ‰éˆ•
            document.getElementById("playBtn").disabled = false;
            document.getElementById("playBtn").innerText = "ğŸ™ èª å¿ƒæ“²ç­Š (Play)";
        }
    }

    function displayResult(args) {
        const { resultType, payout, gameHash } = args;
        
        document.getElementById("hashDisplay").innerText = gameHash;
        
        const payoutBNB = ethers.utils.formatEther(payout);
        const goldGrams = (parseFloat(payoutBNB) * BNB_PRICE_USD / GOLD_PRICE_USD_PER_GRAM).toFixed(4);
        
        let resultHtml = "";
        if (resultType.includes("Li Jiao")) {
            resultHtml = `<div class='critical'>âš¡ å¤©é™ç¥¥ç‘ï¼ç«‹ç­Šæš´æ“Š (8X) âš¡</div>`;
            resultHtml += `<div class='gold-text'>ç²å¾— ${payoutBNB} BNB â‰ˆ ${goldGrams} å…‹é»ƒé‡‘</div>`;
        } else if (resultType.includes("Sheng Jiao")) {
            resultHtml = `<div class='sheng-jiao'>ğŸ™ è–ç­Šï¼ç²åˆ©ç¿»å€ (2X)</div>`;
            resultHtml += `<div class='gold-text'>ç²å¾— ${payoutBNB} BNB â‰ˆ ${goldGrams} å…‹é»ƒé‡‘</div>`;
        } else if (resultType.includes("Xiao Jiao")) {
            resultHtml = `<div class='xiao-jiao'>ğŸ˜Š ç¬‘ç­Š - è™çˆºç¬‘äº† (é€€å›ä¸€åŠ)</div>`;
            resultHtml += `<div style='font-size:16px; margin-top:5px; color:#ccc'>é€£å‹ä¸­æ–·</div>`;
        } else {
            resultHtml = `<div class='yin-jiao'>ğŸŒ‘ é™°ç­Š - ä¸‹æ¬¡å¥½é‹</div>`;
            resultHtml += `<div style='font-size:16px; margin-top:5px; color:#ccc'>é€£å‹æ­¸é›¶</div>`;
        }
        
        document.getElementById("resultDisplay").innerHTML = resultHtml;
        
        // é †ä¾¿æ›´æ–°ä¸€ä¸‹é¤˜é¡
        signer.getAddress().then(addr => updateAllStats(addr));
    }
</script>

</body>
</html>
