<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ§§ æ“²ç­Šåšæ¯ï¼šæ–°æ˜¥è©¦æ‰‹æ°£</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --red: #D90429; --gold: #FFD700; --bg: #2b0505; --dark: #1a0000; }
        body { background: var(--bg); background-image: radial-gradient(circle at center, #500 0%, #1a0000 100%); color: #fff; font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 15px; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); border: 1px solid var(--red); border-radius: 20px; padding: 20px; box-shadow: 0 0 30px rgba(217, 4, 41, 0.3); }
        
        header { text-align: center; margin-bottom: 20px; }
        h1 { color: var(--gold); margin: 0; text-shadow: 0 0 10px var(--red); font-size: 28px; }
        .sub { font-size: 12px; color: #ccc; margin-top: 5px; }
        
        .main-card { background: linear-gradient(135deg, #800000 0%, #300000 100%); border: 2px solid var(--gold); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; position: relative; }
        .pool-title { font-size: 12px; color: #ffcccc; letter-spacing: 1px; }
        .pool-val { font-family: 'Roboto Mono'; font-size: 36px; font-weight: bold; color: #fff; margin: 5px 0; }
        
        .streak-info { display: flex; justify-content: space-around; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin-top: 15px; }
        .s-box { text-align: center; }
        .s-label { font-size: 10px; color: #aaa; }
        .s-val { font-size: 18px; font-weight: bold; color: var(--gold); font-family: 'Roboto Mono'; }
        
        .bet-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .bet-btn { background: #333; border: 1px solid #555; color: #fff; padding: 12px; border-radius: 10px; cursor: pointer; font-family: 'Roboto Mono'; transition: 0.2s; }
        .bet-btn:hover { border-color: var(--gold); background: #444; }
        .bet-btn.active { background: var(--red); border-color: var(--gold); font-weight: bold; }
        
        #playBtn { width: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); color: #500; font-size: 20px; font-weight: bold; padding: 15px; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); margin-bottom: 20px; transition: transform 0.1s; }
        #playBtn:active { transform: scale(0.95); }
        
        .result-box { min-height: 40px; text-align: center; font-size: 16px; margin-bottom: 20px; font-weight: bold; color: var(--gold); text-shadow: 0 0 5px #000; }
        
        .ref-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; font-size: 12px; text-align: center; color: #aaa; margin-bottom: 20px; word-break: break-all; }
        
        .events-log { max-height: 150px; overflow-y: auto; font-size: 12px; border-top: 1px dashed #555; padding-top: 10px; }
        .log-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-win { color: #0f0; } .log-lose { color: #888; }
        
        #connectBtn { width: 100%; background: #222; color: #fff; padding: 10px; border: 1px solid #444; border-radius: 20px; cursor: pointer; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ğŸ§§ æ“²ç­Šåšæ¯ V4</h1>
        <div class="sub">è–ç­Šç¿»å€ â€¢ ç«‹ç­Š 8 å€ â€¢ é€£å‹æ¶é€±ç</div>
    </header>

    <div class="main-card">
        <div class="pool-title">æœ¬é€±é€£å‹çæ± </div>
        <div class="pool-val"><span id="streakPool">0.000</span> <span style="font-size:16px">BNB</span></div>
        <div class="streak-info">
            <div class="s-box"><div class="s-label">å…¨ç¶²æœ€é«˜</div><div class="s-val" id="globalHigh">0</div></div>
            <div class="s-box"><div class="s-label">ä½ çš„é€£å‹</div><div class="s-val" id="myStreak">0</div></div>
            <div class="s-box"><div class="s-label">å€‹äººç´€éŒ„</div><div class="s-val" id="myBest">0</div></div>
        </div>
    </div>

    <div class="result-box" id="resultDisplay">æº–å‚™æ“²ç­Š...</div>

    <div class="bet-area">
        <button class="bet-btn active" onclick="setBet('0.001')">0.001 BNB</button>
        <button class="bet-btn" onclick="setBet('0.005')">0.005 BNB</button>
        <button class="bet-btn" onclick="setBet('0.01')">0.01 BNB</button>
        <button class="bet-btn" onclick="setBet('0.05')">0.05 BNB</button>
    </div>

    <button id="playBtn" onclick="play()">ğŸ™ èª å¿ƒæ“²ç­Š</button>
    
    <button id="connectBtn" onclick="connectWallet()">ğŸ¦Š é€£çµéŒ¢åŒ…</button>

    <div class="ref-box" id="refLink" onclick="copyRef()">é€£çµéŒ¢åŒ…å¾Œé¡¯ç¤ºæ¨å»£é€£çµ (é»æ“Šè¤‡è£½)</div>

    <div class="events-log" id="eventLogs">
        <div style="text-align:center; color:#666">æš«ç„¡ç´€éŒ„</div>
    </div>
</div>

<script>
    const ADDR = "0x51938462eFcB3941DaccDA83480109E3F3C640C5";
    const ABI = [
        "function play(address referrer) external payable",
        "function streakPoolBalance() view returns (uint256)",
        "function highestStreak() view returns (uint256)",
        "function userStreaks(address) view returns (uint64, uint64, uint32, uint32, uint32)",
        "event GameResult(address indexed player, string resultType, uint256 payout, uint256 rawRandom, uint256 betAmount, bytes32 gameHash)"
    ];

    let provider, signer, contract;
    let selectedBet = "0.001";
    let myAddr = "";

    // å–å¾—ç¶²å€åˆ—çš„ referrer
    const urlParams = new URLSearchParams(window.location.search);
    const referrer = urlParams.get('ref') || "0x0000000000000000000000000000000000000000";

    function setBet(amt) {
        selectedBet = amt;
        document.querySelectorAll('.bet-btn').forEach(b => {
            b.classList.remove('active');
            if(b.innerText.includes(amt)) b.classList.add('active');
        });
    }

    async function connectWallet() {
        if (!window.ethereum) return alert("è«‹å®‰è£ MetaMask");
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            myAddr = await signer.getAddress();
            contract = new ethers.Contract(ADDR, ABI, signer);
            
            document.getElementById("connectBtn").innerText = "âœ… " + myAddr.substring(0,6)+"...";
            
            // ç”Ÿæˆæ¨å»£é€£çµ
            const refUrl = window.location.origin + window.location.pathname + "?ref=" + myAddr;
            document.getElementById("refLink").innerText = "æ¨å»£é€£çµ: " + refUrl;
            
            updateData();
            listenEvents();
            setInterval(updateData, 5000);
        } catch(e) { console.error(e); }
    }

    async function updateData() {
        if(!contract) return;
        try {
            const pool = await contract.streakPoolBalance();
            const high = await contract.highestStreak();
            const uData = await contract.userStreaks(myAddr);
            
            document.getElementById("streakPool").innerText = parseFloat(ethers.utils.formatEther(pool)).toFixed(3);
            document.getElementById("globalHigh").innerText = high.toString();
            // uData[2] = currentStreak, uData[3] = personalMax
            document.getElementById("myStreak").innerText = uData[2].toString();
            document.getElementById("myBest").innerText = uData[3].toString();
        } catch(e){}
    }

    function listenEvents() {
        contract.on("GameResult", (player, res, pay, rnd, bet, hash) => {
            if(player.toLowerCase() === myAddr.toLowerCase()) {
                const win = pay.gt(0);
                const txt = win ? `ğŸ‰ ${res} (+${ethers.utils.formatEther(pay)} BNB)` : `ğŸ˜­ ${res}`;
                document.getElementById("resultDisplay").innerText = txt;
                document.getElementById("resultDisplay").style.color = win ? "#0f0" : "#888";
                
                addLog(txt, win);
                updateData(); // ç«‹å³æ›´æ–°
            }
        });
    }

    function addLog(msg, win) {
        const div = document.getElementById("eventLogs");
        const time = new Date().toLocaleTimeString();
        const html = `<div class="log-item ${win?'log-win':'log-lose'}"><span>${time}</span><span>${msg}</span></div>`;
        div.innerHTML = html + div.innerHTML;
    }

    async function play() {
        if(!contract) return alert("è«‹å…ˆé€£çµéŒ¢åŒ…");
        try {
            document.getElementById("resultDisplay").innerText = "ğŸ™ æ“²ç­Šä¸­...";
            document.getElementById("resultDisplay").style.color = "#FFD700";
            
            const tx = await contract.play(referrer, { value: ethers.utils.parseEther(selectedBet) });
            await tx.wait();
        } catch(e) {
            document.getElementById("resultDisplay").innerText = "âŒ äº¤æ˜“å¤±æ•—";
            alert("éŒ¯èª¤: " + (e.data?.message || e.message));
        }
    }

    function copyRef() {
        const txt = document.getElementById("refLink").innerText.replace("æ¨å»£é€£çµ: ", "");
        if(txt.includes("http")) {
            navigator.clipboard.writeText(txt);
            alert("é€£çµå·²è¤‡è£½ï¼");
        }
    }
</script>

</body>
</html>

