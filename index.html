<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§§ é‡‘è›‡è¿æ˜¥ï¼šéˆä¸Šæ“²ç­Šåšé»ƒé‡‘ ğŸ§§</title>
    
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>

    <style>
        body {
            background-color: #800000; /* éå¹´ç´… */
            color: #FFD700; /* é»ƒé‡‘è‰² */
            font-family: 'Microsoft JhengHei', sans-serif;
            text-align: center;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            box-shadow: 0 0 20px #FFD700;
        }
        h1 { margin-bottom: 10px; }
        .btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            color: #800000;
            cursor: pointer;
            border-radius: 50px;
            margin: 10px;
            transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background: #555; color: #888; cursor: not-allowed; }
        
        .input-group { margin: 20px 0; }
        input {
            padding: 10px;
            font-size: 18px;
            border-radius: 5px;
            border: 2px solid #FFD700;
            background: #330000;
            color: white;
            text-align: center;
            width: 150px;
        }
        
        /* äº‚ç¢¼é¡¯ç¤ºå€ */
        .hash-box {
            background-color: #000;
            color: #00FF00; /* é§­å®¢ç¶  */
            font-family: 'Courier New', monospace;
            padding: 10px;
            margin: 15px 0;
            border-radius: 5px;
            font-size: 12px;
            word-break: break-all;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #00FF00;
        }

        .result-area {
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
            min-height: 120px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .gold-text {
            color: #fff;
            font-size: 16px;
            margin-top: 10px;
            background: rgba(218, 165, 32, 0.3);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: bold;
        }
        
        /* å‹•ç•«ç‰¹æ•ˆ */
        @keyframes flash {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        .critical {
            color: #FF00FF;
            text-shadow: 0 0 15px #FF00FF;
            animation: flash 0.5s infinite;
            font-size: 28px;
        }
        .sheng-jiao { color: #FFD700; text-shadow: 0 0 10px #FFD700; }
        .xiao-jiao { color: #FFA500; }
        .yin-jiao { color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¯ è™çˆºè³œç¦æ“²ç­Šå° ğŸ¯</h1>
    <p>é€£çµéŒ¢åŒ… -> è¼¸å…¥é‡‘é¡ -> æ“²å‡ºè–ç­Šæ‹¿é»ƒé‡‘ï¼</p>
    
    <div class="stats">
        <div>ğŸ’° é¤˜é¡: <span id="userBalance">---</span> BNB</div>
        <div>ğŸ”¥ é€£å‹: <span id="userStreak">0</span></div>
    </div>

    <button id="connectBtn" class="btn" onclick="connectWallet()">ğŸ¦Š é€£çµéŒ¢åŒ… (Connect)</button>
    
    <div id="gameArea" style="display:none;">
        <div class="input-group">
            <label>ä¸‹æ³¨é‡‘é¡ (BNB):</label>
            <input type="number" id="betAmount" value="0.001" step="0.001" min="0.001">
        </div>

        <button id="playBtn" class="btn" onclick="playGame()">ğŸ™ èª å¿ƒæ“²ç­Š (Play)</button>

        <div class="hash-box" id="hashDisplay">
            [ è«‹å…ˆæ“²ç­Šï¼Œç­‰å¾…å€å¡Šéˆç”Ÿæˆéš¨æ©Ÿç¢¼... ]
        </div>

        <div class="result-area" id="resultDisplay">
            æº–å‚™å¥½äº†å—ï¼Ÿ<br>è™çˆºçœ‹è‘—ä½ å‘¢...
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âœ… å·²è‡ªå‹•å¡«å…¥ä½ çš„åˆç´„åœ°å€
    // ==========================================
    const CONTRACT_ADDRESS = "0x7A427604Ff8Ce728A60cF5cB247B30C0cE29188B"; 

    // å‡å®šåŒ¯ç‡ (å‰ç«¯é¡¯ç¤ºç”¨)
    const BNB_PRICE_USD = 620; 
    const GOLD_PRICE_USD_PER_GRAM = 85; 

    // åˆç´„ä»‹é¢ (ABI)
    const ABI = [
        "function play(address referrer) external payable",
        "function userStreaks(address) view returns (uint256, uint256, uint256, uint256)",
        "event GameResult(address indexed player, string resultType, uint256 payout, uint256 rawRandom, uint256 betAmount, bytes32 gameHash)"
    ];

    let provider, signer, contract;

    async function connectWallet() {
        if (typeof ethers === 'undefined') {
            alert("âš ï¸ Ethers.js è¼‰å…¥å¤±æ•—ï¼\nè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·šï¼Œæˆ–å˜—è©¦ä½¿ç”¨ VPNã€‚");
            return;
        }

        if (!window.ethereum) {
            alert("è«‹å®‰è£ MetaMask éŒ¢åŒ…æ“´å……åŠŸèƒ½!");
            return;
        }
        
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            
            // è«‹æ±‚ç”¨æˆ¶æˆæ¬Š
            await provider.send("eth_requestAccounts", []); 
            signer = provider.getSigner();
            
            const address = await signer.getAddress();
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—
            document.getElementById("connectBtn").innerText = "âœ… å·²é€£çµ: " + address.substring(0,6) + "...";
            document.getElementById("connectBtn").disabled = true; 
            
            // é¡¯ç¤ºéŠæˆ²å€åŸŸ
            document.getElementById("gameArea").style.display = "block";

            // åˆå§‹åŒ–åˆç´„
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            
            // è®€å–æ•¸æ“š
            await updateStats(address);
            
            // å•Ÿå‹•äº‹ä»¶ç›£è½
            setupEventListener(address);

        } catch (error) {
            console.error(error);
            alert("é€£çµå¤±æ•—: " + (error.message || "æœªçŸ¥éŒ¯èª¤"));
        }
    }

    async function loadStreak(address) {
        try {
            const streakData = await contract.userStreaks(address);
            document.getElementById("userStreak").innerText = streakData[0].toString();
        } catch (e) { 
            console.log("è®€å–é€£å‹å¤±æ•— (å¯èƒ½æ˜¯æ–°ç”¨æˆ¶):", e); 
        }
    }

    async function updateStats(address) {
        try {
            const balance = await provider.getBalance(address);
            document.getElementById("userBalance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
            await loadStreak(address);
        } catch (e) { console.error(e); }
    }

    async function playGame() {
        if (!contract) return;
        
        const betValue = document.getElementById("betAmount").value;
        if (parseFloat(betValue) < 0.001) {
            alert("æœ€å°ä¸‹æ³¨é‡‘é¡ç‚º 0.001 BNB");
            return;
        }

        const referrer = "0x0000000000000000000000000000000000000000"; // æš«ç„¡æ¨è–¦äºº

        try {
            document.getElementById("resultDisplay").innerHTML = "ğŸ² æ“²ç­Šä¸­...<br><span style='font-size:16px; color:#FFD700'>è«‹åœ¨éŒ¢åŒ…ç¢ºèªäº¤æ˜“...</span>";
            document.getElementById("hashDisplay").innerText = "ç­‰å¾…å€å¡Šéˆç¢ºèªä¸­...";
            document.getElementById("playBtn").disabled = true;
            document.getElementById("playBtn").innerText = "â³ äº¤æ˜“ç¢ºèªä¸­...";

            const tx = await contract.play(referrer, { 
                value: ethers.utils.parseEther(betValue) 
            });
            
            console.log("äº¤æ˜“å·²ç™¼é€:", tx.hash);
            document.getElementById("resultDisplay").innerHTML = "ğŸš€ äº¤æ˜“å·²ç™¼é€ï¼<br><span style='font-size:16px; color:#ccc'>ç­‰å¾…å€å¡Šæ‰“åŒ… (ç´„3ç§’)...</span>";
            
            await tx.wait();

        } catch (error) {
            console.error(error);
            let msg = error.data?.message || error.message;
            if (msg.includes("insufficient funds")) msg = "é¤˜é¡ä¸è¶³ï¼";
            if (msg.includes("user rejected")) msg = "ä½¿ç”¨è€…å–æ¶ˆäº¤æ˜“";
            
            alert("äº¤æ˜“å¤±æ•—: " + msg);
            document.getElementById("resultDisplay").innerText = "âŒ äº¤æ˜“æœªå®Œæˆ";
            
            document.getElementById("playBtn").disabled = false;
            document.getElementById("playBtn").innerText = "ğŸ™ èª å¿ƒæ“²ç­Š (Play)";
        }
    }

    function setupEventListener(myAddress) {
        contract.on("GameResult", (player, resultType, payout, rawRandom, betAmount, gameHash) => {
            
            if (player.toLowerCase() === myAddress.toLowerCase()) {
                
                // 1. é¡¯ç¤ºé›œæ¹Šäº‚ç¢¼
                document.getElementById("hashDisplay").innerText = gameHash;
                
                // 2. è¨ˆç®—é»ƒé‡‘
                const payoutBNB = ethers.utils.formatEther(payout);
                const goldGrams = (parseFloat(payoutBNB) * BNB_PRICE_USD / GOLD_PRICE_USD_PER_GRAM).toFixed(4);
                
                // 3. é¡¯ç¤ºçµæœ
                let resultHtml = "";
                
                if (resultType.includes("Li Jiao")) {
                    resultHtml = `<div class='critical'>âš¡ å¤©é™ç¥¥ç‘ï¼ç«‹ç­Šæš´æ“Š (8X) âš¡</div>`;
                    resultHtml += `<div class='gold-text'>ç²å¾— ${payoutBNB} BNB â‰ˆ ${goldGrams} å…‹é»ƒé‡‘</div>`;
                } else if (resultType.includes("Sheng Jiao")) {
                    resultHtml = `<div class='sheng-jiao'>ğŸ™ è–ç­Šï¼ç²åˆ©ç¿»å€ (2X)</div>`;
                    resultHtml += `<div class='gold-text'>ç²å¾— ${payoutBNB} BNB â‰ˆ ${goldGrams} å…‹é»ƒé‡‘</div>`;
                } else if (resultType.includes("Xiao Jiao")) {
                    resultHtml = `<div class='xiao-jiao'>ğŸ˜Š ç¬‘ç­Š - è™çˆºç¬‘äº† (é€€å›ä¸€åŠ)</div>`;
                    resultHtml += `<div style='font-size:14px; margin-top:5px;'>é€£å‹ä¸­æ–·</div>`;
                } else {
                    resultHtml = `<div class='yin-jiao'>ğŸŒ‘ é™°ç­Š - ä¸‹æ¬¡å¥½é‹</div>`;
                    resultHtml += `<div style='font-size:14px; margin-top:5px;'>é€£å‹æ­¸é›¶</div>`;
                }
                
                document.getElementById("resultDisplay").innerHTML = resultHtml;
                
                updateStats(myAddress);
                document.getElementById("playBtn").disabled = false;
                document.getElementById("playBtn").innerText = "ğŸ™ èª å¿ƒæ“²ç­Š (Play)";
            }
        });
    }

</script>

</body>
</html>
