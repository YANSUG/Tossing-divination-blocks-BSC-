<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§§ é‡‘è›‡è¿æ˜¥ï¼šéˆä¸Šæ“²ç­Šåšé»ƒé‡‘ ğŸ§§</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <style>
        body {
            background-color: #800000; /* éå¹´ç´… */
            color: #FFD700; /* é»ƒé‡‘è‰² */
            font-family: 'Microsoft JhengHei', sans-serif;
            text-align: center;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #FFD700;
            box-shadow: 0 0 20px #FFD700;
        }
        h1 { margin-bottom: 10px; }
        .btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            color: #800000;
            cursor: pointer;
            border-radius: 50px;
            margin: 10px;
            transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        .input-group { margin: 20px 0; }
        input {
            padding: 10px;
            font-size: 18px;
            border-radius: 5px;
            border: 2px solid #FFD700;
            background: #330000;
            color: white;
            text-align: center;
            width: 150px;
        }
        
        /* --- é—œéµï¼šé¡¯ç¤ºäº‚ç¢¼çš„å€åŸŸ --- */
        .hash-box {
            background-color: #000;
            color: #00FF00; /* é§­å®¢ç¶  */
            font-family: 'Courier New', monospace;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
            word-break: break-all;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #00FF00;
        }

        .result-area {
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
            min-height: 100px;
        }
        .gold-text {
            color: #fff;
            font-size: 16px;
            margin-top: 5px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        /* å‹•ç•«ç‰¹æ•ˆ */
        @keyframes flash {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }
        .critical {
            color: #FF00FF;
            text-shadow: 0 0 10px #FF00FF;
            animation: flash 0.5s infinite;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¯ è™çˆºè³œç¦æ“²ç­Šå° ğŸ¯</h1>
    <p>é€£çµéŒ¢åŒ… -> è¼¸å…¥é‡‘é¡ -> æ“²å‡ºè–ç­Šæ‹¿é»ƒé‡‘ï¼</p>
    
    <div class="stats">
        <div>ğŸ’° ä½ çš„é¤˜é¡: <span id="userBalance">---</span> BNB</div>
        <div>ğŸ”¥ ä½ çš„é€£å‹: <span id="userStreak">0</span></div>
    </div>

    <button id="connectBtn" class="btn" onclick="connectWallet()">é€£çµéŒ¢åŒ… (Connect)</button>
    
    <div id="gameArea" style="display:none;">
        <div class="input-group">
            <label>ä¸‹æ³¨é‡‘é¡ (BNB):</label>
            <input type="number" id="betAmount" value="0.001" step="0.001" min="0.001">
        </div>

        <button id="playBtn" class="btn" onclick="playGame()">ğŸ™ èª å¿ƒæ“²ç­Š (Play)</button>

        <div class="hash-box" id="hashDisplay">
            [ ç­‰å¾…å€å¡Šéˆéš¨æ©Ÿæ•¸ç”Ÿæˆ... ]
        </div>

        <div class="result-area" id="resultDisplay">
            æº–å‚™å¥½äº†å—ï¼Ÿ
        </div>
    </div>
</div>

<script>
    // ==========================================
    // âš ï¸ è«‹åœ¨é€™è£¡å¡«å…¥ä½ å‰›å‰›éƒ¨ç½²å¥½çš„åˆç´„åœ°å€
    // ==========================================
    const CONTRACT_ADDRESS = "è«‹å¡«å…¥ä½ çš„åˆç´„åœ°å€(0x.....)"; 
    
    // å‡å®šåŒ¯ç‡ (å¯¦éš›ä¸Šæ‡‰è©²æ¥ API)
    const BNB_PRICE_USD = 620; 
    const GOLD_PRICE_USD_PER_GRAM = 85; 

    // åˆç´„ä»‹é¢ (ABI) - åªåˆ—å‡ºå‰ç«¯éœ€è¦çš„å‡½æ•¸
    const ABI = [
        "function play(address referrer) external payable",
        "function userStreaks(address) view returns (uint256, uint256, uint256, uint256)",
        "event GameResult(address indexed player, string resultType, uint256 payout, uint256 rawRandom, uint256 betAmount, bytes32 gameHash)"
    ];

    let provider, signer, contract;

    async function connectWallet() {
        if (!window.ethereum) {
            alert("è«‹å®‰è£ MetaMask!");
            return;
        }
        try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []); // è«‹æ±‚æˆæ¬Š
            signer = provider.getSigner();
            
            const address = await signer.getAddress();
            const balance = await provider.getBalance(address);
            
            document.getElementById("connectBtn").innerText = "âœ… å·²é€£çµ: " + address.substring(0,6) + "...";
            document.getElementById("userBalance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
            document.getElementById("gameArea").style.display = "block";

            // åˆå§‹åŒ–åˆç´„
            contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
            
            // è®€å–é€£å‹ç‹€æ…‹
            loadStreak(address);
            
            // --- ç›£è½äº‹ä»¶ (æœ€é—œéµçš„éƒ¨åˆ†) ---
            setupEventListener();

        } catch (error) {
            console.error(error);
            alert("é€£çµå¤±æ•—: " + error.message);
        }
    }

    async function loadStreak(address) {
        try {
            const streakData = await contract.userStreaks(address);
            document.getElementById("userStreak").innerText = streakData[0].toString();
        } catch (e) { console.log(e); }
    }

    async function playGame() {
        if (!contract) return;
        
        const betValue = document.getElementById("betAmount").value;
        const referrer = "0x0000000000000000000000000000000000000000"; // æš«ç„¡æ¨è–¦äºº

        try {
            document.getElementById("resultDisplay").innerHTML = "ğŸ² æ“²ç­Šä¸­...<br><span style='font-size:14px; color:#ccc'>ç­‰å¾…å€å¡Šç¢ºèª (ç´„3ç§’)</span>";
            document.getElementById("hashDisplay").innerText = "Generating Hash on-chain...";
            document.getElementById("playBtn").disabled = true;

            // ç™¼é€äº¤æ˜“
            const tx = await contract.play(referrer, { 
                value: ethers.utils.parseEther(betValue) 
            });
            
            console.log("äº¤æ˜“ç™¼é€:", tx.hash);
            // é€™è£¡æˆ‘å€‘ä¸ç­‰ tx.wait() å®Œæˆæ‰é¡¯ç¤ºçµæœï¼Œè€Œæ˜¯ä¾è³´ Event Listener æ¯”è¼ƒå¿«
            await tx.wait(); // ç­‰å¾…ä¸Šéˆ
            
        } catch (error) {
            console.error(error);
            alert("äº¤æ˜“å¤±æ•—: " + (error.data?.message || error.message));
            document.getElementById("resultDisplay").innerText = "âŒ äº¤æ˜“å–æ¶ˆæˆ–å¤±æ•—";
            document.getElementById("playBtn").disabled = false;
        }
    }

    // --- ç›£è½åˆç´„äº‹ä»¶ä¾†é¡¯ç¤ºçµæœ ---
    function setupEventListener() {
        contract.on("GameResult", (player, resultType, payout, rawRandom, betAmount, gameHash) => {
            
            // ç¢ºèªæ˜¯ç•¶å‰ç©å®¶çš„äº‹ä»¶
            signer.getAddress().then(myAddr => {
                if (player.toLowerCase() === myAddr.toLowerCase()) {
                    
                    // 1. é¡¯ç¤ºé§­å®¢äº‚ç¢¼ (Hash)
                    document.getElementById("hashDisplay").innerText = gameHash;
                    
                    // 2. è¨ˆç®—é»ƒé‡‘é‡é‡
                    const payoutBNB = ethers.utils.formatEther(payout);
                    const goldGrams = (parseFloat(payoutBNB) * BNB_PRICE_USD / GOLD_PRICE_USD_PER_GRAM).toFixed(4);
                    
                    // 3. é¡¯ç¤ºçµæœæ–‡å­—èˆ‡ç‰¹æ•ˆ
                    let resultHtml = "";
                    let color = "white";
                    
                    if (resultType.includes("Li Jiao")) {
                        // ç«‹ç­Šæš´æ“Š
                        resultHtml = `<div class='critical'>âš¡ å¤©é™ç¥¥ç‘ï¼ç«‹ç­Šæš´æ“Š (8X) âš¡</div>`;
                        resultHtml += `<div class='gold-text'>ç²å¾— ${payoutBNB} BNB â‰ˆ ${goldGrams} å…‹é»ƒé‡‘</div>`;
                    } else if (resultType.includes("Sheng Jiao")) {
                        // è–ç­Š
                        resultHtml = `<div style='color:#FFD700'>ğŸ™ è–ç­Šï¼ç²åˆ©ç¿»å€ (2X)</div>`;
                        resultHtml += `<div class='gold-text'>ç²å¾— ${payoutBNB} BNB â‰ˆ ${goldGrams} å…‹é»ƒé‡‘</div>`;
                    } else if (resultType.includes("Xiao Jiao")) {
                        // ç¬‘ç­Š
                        resultHtml = `<div style='color:#FFA500'>ğŸ˜Š ç¬‘ç­Š - è™çˆºç¬‘äº† (é€€å›ä¸€åŠ)</div>`;
                    } else {
                        // é™°ç­Š
                        resultHtml = `<div style='color:#ccc'>ğŸŒ‘ é™°ç­Š - ä¸‹æ¬¡å¥½é‹</div>`;
                    }
                    
                    document.getElementById("resultDisplay").innerHTML = resultHtml;
                    
                    // åˆ·æ–°é¤˜é¡èˆ‡é€£å‹
                    updateStats(myAddr);
                    document.getElementById("playBtn").disabled = false;
                }
            });
        });
    }
    
    async function updateStats(address) {
        const balance = await provider.getBalance(address);
        document.getElementById("userBalance").innerText = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
        loadStreak(address);
    }

</script>

</body>
</html>